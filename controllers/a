
exports.login = async (req, res) => {
  try {
    let { emp_id, password } = req.body;

    if (!emp_id || !password) {
      return res.status(400).json({ message: "Please provide emp_id and password" });
    }

    emp_id = emp_id.trim();

    // 1️⃣ CHECK IF ADMIN LOGIN
    let user = await User.findOne({ where: { emp_id } });

    if (user && user.role === "Admin") {
      // ADMIN --> validate directly from USER table

      const isMatch = await bcrypt.compare(password.trim(), user.password);

      if (!isMatch) {
        return res.status(400).json({ message: "Incorrect password" });
      }

      // req.session.user = {
      //   id: user.id,
      //   emp_id: user.emp_id,
      //   name: user.name,
      //   user_id: user.user_id,
      //   role: user.role,
      //   department: user.department,
      // };

      // Issue JWT for admin
      const token = jwt.sign(
        {
          id: user.id,
          emp_id: user.emp_id,
          name: user.name,
          user_id: user.user_id,
          role: user.role,
          department: user.department,
          joining_date: user.joining_date,
          permissions: ["*"],
        },
        process.env.JWT_SECRET,
        { expiresIn: "1h" }
      );

      return res.status(200).json({
        message: "Admin login successful",
        token,
        user,
      });
    }

    // 2️⃣ NORMAL USER LOGIN - Fetch emp_id from IdentityCard
    const identity = await IdentityCard.findOne({ where: { emp_id } });

    if (!identity) {
      return res.status(400).json({ message: "Invalid emp_id" });
    }

    let displayUser = identity.display_user;
    if (typeof displayUser === "string") {
      displayUser = JSON.parse(displayUser);
    }

    let permissions = Array.isArray(displayUser.permissions) ? displayUser.permissions : [];

    if (identity && identity.display_user && Array.isArray(identity.display_user.permissions)) {
      permissions = identity.display_user.permissions;
    }

    // Now fetch user using identity.user_id (FK)
    user = await User.findOne({ where: { id: identity.user_id } });

    if (!user) {
      return res.status(400).json({ message: "User not found for this Identity Card" });
    }

    if (user.status === "deactivated") {
      return res.status(403).json({ message: "Your account is deactivated." });
    }

    // Compare password from User table
    const isMatch = await bcrypt.compare(password.trim(), user.password);

    if (!isMatch) {
      return res.status(400).json({ message: "Incorrect password" });
    }

    if (!user.role || user.role.trim() === "") {
      user.role = "User";
    }


    // req.session.user = {
    //   id: user.id,
    //   emp_id: identity.emp_id,
    //   name: user.name,
    //   user_id: user.user_id,
    //   role: user.role,
    //   department: user.department,
    //  // permissions: permissions,
    // };
    // Generate JWT
    const token = jwt.sign(
      {
        id: user.id,
        emp_id: identity.emp_id,   // emp_id from identity card
        name: user.name,
        user_id: user.user_id,
        role: user.role,
        department: user.department,
        joining_date: user.joining_date,
        permissions: permissions
      },
      process.env.JWT_SECRET,
      { expiresIn: "1h" }
    );

    return res.status(200).json({
      message: "Login successful",
      token,
      user,
    });

  } catch (err) {
    console.error(err);
    res.status(500).json({ message: "Internal server error" });
  }
};

